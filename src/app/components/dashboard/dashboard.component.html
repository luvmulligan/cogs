<div class="container">
  <div *ngIf="loading" style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
    <p-progress-spinner ariaLabel="loading" />
  </div>

  <div *ngIf="!loading">
    <div class="dashboard-header">
      <h2><span class="material-icons">dashboard</span>{{ t.dashboard }}</h2>
      <button class="btn btn-primary" (click)="toggleBusinessForm()">
        {{ showBusinessForm ? t.cancel : '+ ' + t.createBusiness }}
      </button>
    </div>

    <!-- Formulario de nuevo negocio -->
    <app-business-form 
      *ngIf="showBusinessForm"
      (businessCreated)="onBusinessCreated()">
    </app-business-form>
    
    <!-- Sin negocios -->
    <div class="empty-state card" *ngIf="businesses.length === 0 && !showBusinessForm && !loading">
      <h3>¡Bienvenido a AppCogs!</h3>
      <p>Comienza creando tu primer negocio para empezar a gestionar costos y calcular precios.</p>
      <button class="btn btn-primary" (click)="toggleBusinessForm()">
        {{ t.createBusiness }}
      </button>
    </div>

    <!-- Dashboard principal -->
    <div *ngIf="businesses.length > 0 && !showBusinessForm">
    <!-- Selector de negocio -->
    <div class="business-selector card" *ngIf="businesses.length > 1">
      <label>{{ t.selectBusiness }}:</label>
      <div class="business-buttons">
        <button 
          *ngFor="let business of businesses"
          class="business-btn"
          [class.active]="selectedBusiness?.id === business.id"
          (click)="selectBusiness(business)">
          {{ business.name }}
        </button>
      </div>
    </div>

    <!-- Información del negocio actual -->
    <div class="business-info card" *ngIf="selectedBusiness">
      <div class="business-header">
        <div>
          <h3>{{ selectedBusiness.name }}</h3>
          <p class="industry">{{ selectedBusiness.industry }}</p>
          <p class="description" *ngIf="selectedBusiness.description">
            {{ selectedBusiness.description }}
          </p>
        </div>
        <button class="btn btn-secondary" (click)="showFixedCostsForm = !showFixedCostsForm">
          <span class="material-icons">settings</span>
          {{ showFixedCostsForm ? t.close : t.manageFixedCosts }}
        </button>
        <button class="btn btn-secondary" (click)="toggleAssetsForm()">
          <span class="material-icons">inventory_2</span>
          {{ showAssetsForm ? t.close : t.manageAssets }}
        </button>
      </div>

      <!-- Costos Fijos del Negocio -->
      <div class="fixed-costs-section" *ngIf="showFixedCostsForm">
        <h4><span class="material-icons">account_balance</span> {{ t.fixedCostsTitle }}</h4>
        <p class="info-text">
          <span class="material-icons icon-tip">info</span>
          {{ t.fixedCostsInfo }}
        </p>

        <div class="fixed-costs-list" *ngIf="businessFixedCosts.length > 0">
          <div class="fixed-cost-item" *ngFor="let cost of businessFixedCosts">
            <div class="cost-info">
              <strong>{{ cost.name }}</strong>
              <span class="cost-type-badge">{{ getCostTypeLabel(cost.type) }}</span>
            </div>
            <div class="cost-value">${{ cost.monthlyValue | number:'1.2-2' }}/{{ t.monthly }}</div>
            <button class="btn-icon" (click)="deleteFixedCost(cost.id)" [title]="t.delete">
              <span class="material-icons">delete</span>
            </button>
          </div>
          <div class="fixed-costs-total">
            <strong>{{ t.totalFixedCosts }}:</strong>
            <strong class="total-amount">${{ getTotalFixedCosts() | number:'1.2-2' }}</strong>
          </div>
        </div>

        <div class="add-fixed-cost-form">
          <h5>{{ t.addCostButton }}</h5>
          <div class="form-inline">
            <input 
              type="text" 
              [(ngModel)]="newFixedCost.name" 
              [placeholder]="t.conceptPlaceholder"
              class="form-control">
            <select [(ngModel)]="newFixedCost.type" class="form-control">
              <option value="fixed">Costo Fijo</option>
              <option value="overhead">Gasto General</option>
              <option value="labor">Salario Administrativo</option>
            </select>
            <input 
              type="number" 
              [(ngModel)]="newFixedCost.monthlyValue" 
              [placeholder]="t.monthlyCost"
              class="form-control"
              min="0"
              step="0.01">
            <button class="btn btn-success" (click)="addFixedCost()" [disabled]="!isFixedCostValid()">
              <span class="material-icons">add</span> {{ t.add }}
            </button>
          </div>
        </div>
      </div>

      <!-- Activos e Inversiones -->
      <div class="assets-section" *ngIf="showAssetsForm">
        <h4><span class="material-icons">inventory_2</span> {{ t.assetsTitle }}</h4>
        <p class="info-text">
          <span class="material-icons icon-tip">info</span>
          {{ t.assetsInfo }}
        </p>

        <div class="assets-list" *ngIf="assets.length > 0">
          <div class="asset-item" *ngFor="let asset of assets">
            <div class="asset-main-info">
              <div class="asset-details">
                <strong>{{ asset.name }}</strong>
                <span class="asset-type-badge">{{ getAssetTypeLabel(asset.type) }}</span>
                <p class="asset-description" *ngIf="asset.description">{{ asset.description }}</p>
              </div>
              <button class="btn-icon" (click)="deleteAsset(asset.id)" [title]="t.delete">
                <span class="material-icons">delete</span>
              </button>
            </div>
            <div class="asset-financial">
              <div class="asset-stat">
                <span class="stat-label">{{ t.purchaseValue }}:</span>
                <span class="stat-value">${{ asset.purchaseValue | number:'1.2-2' }}</span>
              </div>
              <div class="asset-stat">
                <span class="stat-label">{{ t.estimatedDuration }}:</span>
                <span class="stat-value">{{ asset.usefulLifeMonths }} {{ t.months }}</span>
              </div>
              <div class="asset-stat highlight">
                <span class="stat-label">{{ t.monthlyDepreciation }}:</span>
                <span class="stat-value">${{ getAssetDepreciation(asset) | number:'1.2-2' }}/{{ t.monthly }}</span>
              </div>
            </div>
          </div>
          
          <div class="assets-total">
            <strong>{{ t.totalDepreciation }}:</strong>
            <strong class="total-amount">${{ getTotalDepreciation() | number:'1.2-2' }}</strong>
          </div>
          
          <div class="combined-fixed-costs">
            <div class="combined-row">
              <span>{{ t.traditionalCosts }}:</span>
              <span>${{ getTotalFixedCosts() | number:'1.2-2' }}</span>
            </div>
            <div class="combined-row">
              <span>{{ t.assetDepreciation }}:</span>
              <span>${{ getTotalDepreciation() | number:'1.2-2' }}</span>
            </div>
            <div class="combined-row total">
              <strong>{{ t.totalCombined }}:</strong>
              <strong>${{ getTotalFixedCosts() + getTotalDepreciation() | number:'1.2-2' }}</strong>
            </div>
          </div>
        </div>

        <div class="add-asset-form">
          <h5>{{ t.addAssetButton }}</h5>
          <div class="form-grid">
            <div class="form-group">
              <label>{{ t.assetName }}</label>
              <input 
                type="text" 
                [(ngModel)]="newAsset.name" 
                [placeholder]="t.assetNamePlaceholder"
                class="form-control">
            </div>
            
            <div class="form-group">
              <label>{{ t.assetType }}</label>
              <select [(ngModel)]="newAsset.type" class="form-control">
                <option *ngFor="let type of assetTypes" [value]="type">
                  {{ getAssetTypeLabel(type) }}
                </option>
              </select>
            </div>
            
            <div class="form-group">
              <label>{{ t.purchaseValue }} ($)</label>
              <input 
                type="number" 
                [(ngModel)]="newAsset.purchaseValue" 
                placeholder="0.00"
                class="form-control"
                min="0"
                step="0.01">
            </div>
            
            <div class="form-group">
              <label>{{ t.estimatedDuration }}</label>
              <input 
                type="number" 
                [(ngModel)]="newAsset.usefulLifeMonths" 
                placeholder="12"
                class="form-control"
                min="1">
              <small class="hint">{{ t.estimatedDurationHint }}</small>
            </div>
            
            <div class="form-group full-width">
              <label>{{ t.description }} ({{ t.optional }})</label>
              <input 
                type="text" 
                [(ngModel)]="newAsset.description" 
                [placeholder]="t.descriptionPlaceholder"
                class="form-control">
            </div>

            <div class="form-actions full-width">
              <button class="btn btn-success" (click)="addAsset()" [disabled]="!isAssetValid()">
                <span class="material-icons">add</span> {{ t.addAssetButton }}
              </button>
              <button class="btn btn-secondary" (click)="toggleAssetsForm()">
                {{ t.cancel }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráfico de Gastos por Categoría -->
    <div class="expense-chart-section card">
      <h4>
        <span class="material-icons">pie_chart</span>
        Distribución de Gastos Mensuales por Categoría
      </h4>
      <div class="chart-container">
        <div class="chart-canvas-wrapper">
          <canvas #expenseChart width="300" height="300"></canvas>
        </div>
        <div class="chart-legend">
          <div class="legend-item" *ngFor="let expense of getExpensesByCategory()">
            <div class="legend-color" [style.background-color]="expense.color"></div>
            <div class="legend-label">
              <span class="legend-category">{{ expense.category }}</span>
              <span class="legend-amount">${{ expense.amount | number:'1.2-2' }}</span>
              <span class="legend-percentage">
                {{ getExpensePercentage(expense.amount) | number:'1.0-0' }}%
              </span>
            </div>
          </div>
          <div class="legend-total">
            <strong>Total Mensual:</strong>
            <strong class="total-amount">
              ${{ getTotalExpenses() | number:'1.2-2' }}
            </strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Estadísticas -->
    <div class="stats-grid grid grid-3">
      <div class="stat-card card">
        <div class="stat-icon"><span class="material-icons bigger--icon">inventory_2</span></div>
        <div class="stat-value">{{ stats.totalProducts }}</div>
        <div class="stat-label">{{ t.products }}</div>
      </div>

      <div class="stat-card card">
        <div class="stat-icon"><span class="material-icons bigger--icon">data_thresholding</span></div>
        <div class="stat-value">{{ stats.avgMargin | number:'1.1-1' }}%</div>
        <div class="stat-label">{{ t.margin }}</div>
      </div>

      <div class="stat-card card">
        <div class="stat-icon"><span class="material-icons bigger--icon">check_box</span></div>
        <div class="stat-value">{{ stats.profitableProducts }}/{{ stats.totalProducts }}</div>
        <div class="stat-label">Productos Rentables</div>
      </div>
    </div>

    <!-- Lista de productos -->
    <div class="products-section card">
      <div class="section-header">
        <h3>{{ t.products }}</h3>
        <a routerLink="/calculator" class="btn btn-primary">+ {{ t.addProduct }}</a>
      </div>

      <div class="products-list" *ngIf="getProductsForBusiness().length > 0">
        <div class="product-item" *ngFor="let product of getProductsForBusiness()">
          <div class="product-info">
            <div class="product-name">{{ product.name }}</div>
            <div class="product-details">
              <span class="product-margin">{{ t.margin }}: {{ product.targetMargin }}%</span>
              <span class="product-units" *ngIf="product.expectedMonthlyUnits">
                {{ product.expectedMonthlyUnits }} {{ t.expectedUnits }}
              </span>
              <span class="product-units warning" *ngIf="!product.expectedMonthlyUnits">
                ⚠️ Sin unidades esperadas
              </span>
            </div>
          </div>
          <button class="btn-icon" (click)="editProductUnits(product)" [title]="t.edit">
            <span class="material-icons">edit</span>
          </button>
        </div>
      </div>

      <div class="empty-products" *ngIf="getProductsForBusiness().length === 0">
        <p>No hay productos registrados aún.</p>
        <a routerLink="/calculator" class="btn btn-success">{{ t.addProduct }}</a>
      </div>
    </div>

    <!-- Accesos rápidos -->
    <div class="quick-actions grid grid-3">
      <a routerLink="/calculator" class="action-card card">
        <div class="action-icon"><span class="material-icons bigger--icon">calculate</span></div>
        <h4>{{ t.calculator }}</h4>
        <p>{{ t.calculatorSubtitle }}</p>
      </a>

      <a routerLink="/analysis" class="action-card card">
        <div class="action-icon"><span class="material-icons bigger--icon">payments</span></div>
        <h4>{{ t.analysis }}</h4>
        <p>{{ t.analysisSubtitle }}</p>
      </a>

      <a routerLink="/education" class="action-card card">
        <div class="action-icon"><span class="material-icons bigger--icon">menu_book</span></div>
        <h4>{{ t.education }}</h4>
        <p>{{ t.guideSubtitle }}</p>
      </a>
    </div>
  </div>
</div>
